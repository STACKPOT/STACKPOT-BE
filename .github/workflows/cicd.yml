name: CI/CD Pipeline

on:
  push:
    branches: [ dev ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Make application.yml
        run: |
          cd ./src/main/resources
          echo "${{ secrets.APPLICATION_YML }}" > ./application.yml
        shell: bash

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      - name: Build with Gradle
        uses: gradle/gradle-build-action@v2
        with:
          arguments: build

      # 여기까지는 "코드"를 빌드하는 작업!

      # 이제 EC2로 SSH 접속해서 "docker build, compose up" 수행
      - name: SSH into EC2 and Deploy
        uses: appleboy/ssh-action@v0.1.10
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "[INFO] EC2 서버 접속 완료"
            cd ~/stackpot

            echo "[INFO] 현재 docker-compose down 시작"
            sudo docker-compose down || true

            echo "[INFO] 새 Docker 이미지 build 시작 (Blue or Green 선택은 스위칭 스크립트에서)"
            ./build_and_switch.sh

            echo "[INFO] Docker Compose Up (백그라운드)"
            sudo docker-compose up -d

            echo "[INFO] 필요 없는 Docker 이미지 청소"
            sudo docker image prune -f